#:schema node_modules/wrangler/config-schema.json
name = "ness-vlm-tracker"
compatibility_date = "2024-01-15"

# =====================================
# WEBHOOK RECEIVER WORKER
# =====================================
[[workers]]
name = "webhook-receiver"
main = "workers/webhook-receiver/index.ts"
compatibility_date = "2024-01-15"

# Variáveis de ambiente
[workers.vars]
CORE_PROCESSOR_URL = "https://core-processor.ness-vlm.workers.dev"

# Secrets (configurar via: wrangler secret put WEBHOOK_SECRET)
# WEBHOOK_SECRET = "..."

# KV Namespace para rate limiting
[[workers.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "your-kv-namespace-id"
preview_id = "your-preview-kv-namespace-id"

# Rotas
[[workers.routes]]
pattern = "webhooks.vlm-tracker.ness.com/*"
zone_name = "ness.com"

# =====================================
# CORE PROCESSOR WORKER
# =====================================
[[workers]]
name = "core-processor"
main = "workers/core-processor/index.ts"
compatibility_date = "2024-01-15"

# D1 Database binding
[[workers.d1_databases]]
binding = "VLM_DB"
database_name = "ness_vlm_db"
database_id = "your-d1-database-id"

# R2 Storage binding
[[workers.r2_buckets]]
binding = "VLM_STORAGE"
bucket_name = "ness-vlm-storage"
preview_bucket_name = "ness-vlm-storage-preview"

# Durable Object bindings
[[workers.durable_objects.bindings]]
name = "TRANSLATION_QUEUE"
class_name = "TranslationQueue"
script_name = "translation-agent"

[[workers.durable_objects.bindings]]
name = "JIRA_QUEUE"
class_name = "JiraQueue"
script_name = "jira-integration"

# Rotas
[[workers.routes]]
pattern = "api.vlm-tracker.ness.com/process"
zone_name = "ness.com"

# =====================================
# TRANSLATION AGENT WORKER
# =====================================
[[workers]]
name = "translation-agent"
main = "workers/translation-agent/index.ts"
compatibility_date = "2024-01-15"

# Workers AI binding
[workers.ai]
binding = "AI"

# D1 Database binding
[[workers.d1_databases]]
binding = "VLM_DB"
database_name = "ness_vlm_db"
database_id = "your-d1-database-id"

# Durable Object
[[workers.durable_objects.bindings]]
name = "TRANSLATION_QUEUE"
class_name = "TranslationQueue"

[[workers.migrations]]
tag = "v1"
new_classes = ["TranslationQueue"]

# Rotas
[[workers.routes]]
pattern = "api.vlm-tracker.ness.com/translate"
zone_name = "ness.com"

# =====================================
# JIRA INTEGRATION WORKER
# =====================================
[[workers]]
name = "jira-integration"
main = "workers/jira-integration/index.ts"
compatibility_date = "2024-01-15"

# Variáveis de ambiente
[workers.vars]
JIRA_PROJECT_KEY = "APPWEB"

# Secrets (configurar via wrangler secret put)
# JIRA_BASE_URL = "https://your-company.atlassian.net"
# JIRA_USER = "security@company.com"
# JIRA_API_TOKEN = "..."

# D1 Database binding
[[workers.d1_databases]]
binding = "VLM_DB"
database_name = "ness_vlm_db"
database_id = "your-d1-database-id"

# Durable Object
[[workers.durable_objects.bindings]]
name = "JIRA_QUEUE"
class_name = "JiraQueue"

[[workers.migrations]]
tag = "v1"
new_classes = ["JiraQueue"]

# Rotas
[[workers.routes]]
pattern = "api.vlm-tracker.ness.com/jira"
zone_name = "ness.com"

# =====================================
# CONFIGURAÇÕES GLOBAIS
# =====================================

# Limites de CPU (tempo de execução)
[build]
command = "npm install && npm run build"

[build.upload]
format = "service-worker"

# Observability
[observability]
enabled = true
head_sampling_rate = 0.01
